pipeline {
    agent { label 'run-test-node' }
    environment {
             AWS_ACCESS_KEY_ID = credentials('AWS-Access-Secret-Key')
             imageTag = "demo-project-${env.BUILD_NUMBER}"
             registry = 'nikhildocker1986/demoproject'
             registryCredential = 'DockerHub'
             }
    stages {

    stage('Replace IMAGE_VERSION with build number in docker compose file') {
        steps {
            dir('C:/jenkins-runTests/workspace/terraform-file-execute') {
                bat """
                powershell -Command "(Get-Content docker-compose.yml) -replace 'nikhildocker1986/demoproject:.*','nikhildocker1986/demoproject:${env.BUILD_NUMBER}' | Set-Content docker-compose.yml"
                """
            }
        }
    }
    stage('Copy docker-compose.yml') {
        steps {
            script {
                bat "copy C:\\jenkins-runTests\\workspace\\terraform-file-execute\\docker-compose.yml C:\\jenkins-runTests-docker-compose\\"
            }
        }
    }

     stage('Push updated docker-compose.yml to GitHub') {
                                steps {
                                    withCredentials([usernamePassword(credentialsId: 'GithubCredentials', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')]) {
                                        dir('C:/jenkins-runTests-docker-compose') {
                                            bat """
                                                git config user.email "Nikhil.mlk19861986@gmail.com"
                                                git config user.name "nikhil-mlk"

                                                git status
                                                git pull origin master --allow-unrelated-histories
                                                git add docker-compose.yml
                                                git commit -m "Updated docker-compose with build number ${env.BUILD_NUMBER}"
                                                git push -f origin master

                                            """
                                        }
                                    }
                                }
                            }


       }
}





